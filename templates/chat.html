<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat con {{ wa_id }} ‚Äî PixelBot</title>

<style>
body {
    margin: 0;
    font-family: Inter, Arial, sans-serif;
    background: #f5f6f8;
}

.topbar {
    background: white;
    padding: 16px;
    font-weight: 600;
    border-bottom: 1px solid #ddd;
    display: flex;
    align-items: center;
    gap: 12px;
}

.status {
    font-size: 13px;
    padding: 4px 8px;
    border-radius: 6px;
}

.status.bot { background: #e6f4ea; color: #137333; }
.status.human { background: #fdecea; color: #b3261e; }
.status.timed { background: #fff4e5; color: #b06000; }

.chat-container {
    max-width: 700px;
    margin: auto;
    padding: 20px;
    padding-bottom: 120px;
    height: calc(100vh - 140px);
    overflow-y: auto;
}

.message-row {
    display: flex;
    margin: 6px 0;
}

.message-row.left { justify-content: flex-start; }
.message-row.right { justify-content: flex-end; }

.message {
    max-width: 75%;
    padding: 10px 12px;
    border-radius: 12px;
    font-size: 14px;
}

.left .message {
    background: white;
    border: 1px solid #ddd;
}

.right .message {
    background: #dcf8c6;
}

.timestamp {
    font-size: 11px;
    color: #777;
    text-align: right;
    margin-top: 4px;
}

.sticker-img {
    width: 180px;
    border-radius: 8px;
}

.input-area {
    position: fixed;
    bottom: 0;
    width: 100%;
    background: white;
    border-top: 1px solid #ddd;
    padding: 12px;
}

.input-body {
    max-width: 700px;
    margin: auto;
    display: flex;
    gap: 10px;
}

input {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
}

button {
    padding: 10px 14px;
    border-radius: 8px;
    border: none;
    background: #4d7bff;
    color: white;
    cursor: pointer;
}
</style>
</head>

<body>

<div class="topbar">
    <a href="/">‚Üê</a>
    Chat con {{ wa_id }}
    <span id="statusBadge" class="status"></span>

    <form action="/chat/{{ wa_id }}/close" method="POST" style="margin-left:auto">
        <button type="submit">ü§ñ Reactivar bot</button>
    </form>
</div>

<div id="chat"
     class="chat-container"
     data-wa="{{ wa_id }}"
     data-count="{{ messages|length }}">

{% for sender, message, timestamp in messages %}
<div class="message-row {{ 'left' if sender == 'usuario' else 'right' }}">
    <div class="message">
        {% if "[sticker]" in message %}
            <img src="{{ message.replace('[sticker]', '') }}" class="sticker-img">
        {% else %}
            {{ message }}
        {% endif %}
        <div class="timestamp">{{ timestamp }}</div>
    </div>
</div>
{% endfor %}
</div>

<form id="sendForm" class="input-area">
    <div class="input-body">
        <input type="text" id="text" placeholder="Escrib√≠ un mensaje..." required>
        <button>Enviar</button>
    </div>
</form>

<script>
const chat = document.getElementById("chat");
let lastCount = parseInt(chat.dataset.count, 10);
const WA = chat.dataset.wa;

// üîÑ refrescar mensajes
async function refreshChat() {
    const res = await fetch(`/api/chat/${WA}/messages`);
    const data = await res.json();

    for (let i = lastCount; i < data.messages.length; i++) {
        const m = data.messages[i];
        const side = m.sender === "usuario" ? "left" : "right";

        const row = document.createElement("div");
        row.className = `message-row ${side}`;

        const content = m.message.startsWith("[sticker]")
            ? `<img src="${m.message.replace("[sticker]", "")}" class="sticker-img">`
            : m.message;

        row.innerHTML = `
            <div class="message">
                ${content}
                <div class="timestamp">${m.timestamp}</div>
            </div>
        `;
        chat.appendChild(row);
    }

    lastCount = data.messages.length;
    chat.scrollTop = chat.scrollHeight;
}

// üî¥ estado bot / humano
async function refreshStatus() {
    const res = await fetch(`/api/chat/${WA}/status`);
    const data = await res.json();
    const badge = document.getElementById("statusBadge");

    badge.className = "status";

    if (data.status === "bot") {
        badge.textContent = "üü¢ Bot activo";
        badge.classList.add("bot");
    } else if (data.status === "human") {
        badge.textContent = "üî¥ Humano activo";
        badge.classList.add("human");
    } else {
        badge.textContent = "‚è≥ Humano (temporal)";
        badge.classList.add("timed");
    }
}

// enviar mensaje
document.getElementById("sendForm").addEventListener("submit", async e => {
    e.preventDefault();
    const input = document.getElementById("text");
    const text = input.value;
    input.value = "";

    await fetch(`/send_message/${WA}`, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ text })
    });

    refreshChat();
});

setInterval(refreshChat, 2000);
setInterval(refreshStatus, 3000);
refreshChat();
refreshStatus();
</script>

</body>
</html>

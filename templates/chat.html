<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat con {{ wa_id }} — PixelBot</title>

<style>
/* (estilos iguales, omitidos por brevedad) */
</style>
</head>
<body>

<div class="topbar">
    <a href="/">←</a> Chat con {{ wa_id }}
</div>

<div id="chat-container"
     class="chat-container"
     data-last-count="{{ messages|length }}"
     data-wa-id="{{ wa_id }}">

    {% for sender, message, timestamp in messages %}
        <div class="message-row {{ 'left' if sender == 'usuario' else 'right' }}">
            <div class="message">
                {% if "[sticker]" in message %}
                    <img src="{{ message.replace('[sticker]', '') }}" class="sticker-img">
                {% else %}
                    {{ message }}
                {% endif %}
                <div class="timestamp">{{ timestamp }}</div>
            </div>
        </div>
    {% endfor %}
</div>

<form class="input-area" id="chat-form">
    <input type="text" id="input-text" required>
    <button type="submit">Enviar</button>
</form>

<script>
const container = document.getElementById("chat-container");
let lastCount = parseInt(container.dataset.lastCount, 10);
const WA_ID = container.dataset.waId;

async function refreshChat() {
    const res = await fetch("/api/chat/" + WA_ID + "/messages");
    const data = await res.json();

    for (let i = lastCount; i < data.messages.length; i++) {
        const m = data.messages[i];
        const side = m.sender === "usuario" ? "left" : "right";

        const content = m.message.startsWith("[sticker]")
            ? '<img src="' + m.message.replace("[sticker]", "") + '" class="sticker-img">'
            : m.message;

        const row = document.createElement("div");
        row.className = "message-row " + side;
        row.innerHTML =
            '<div class="message">' +
            content +
            '<div class="timestamp">' + m.timestamp + '</div>' +
            '</div>';

        container.appendChild(row);
    }

    lastCount = data.messages.length;
    container.scrollTop = container.scrollHeight;
}

document.getElementById("chat-form").addEventListener("submit", async function(e) {
    e.preventDefault();
    const input = document.getElementById("input-text");
    const text = input.value;
    input.value = "";

    await fetch("/send_message/" + WA_ID, {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: new URLSearchParams({text})
    });

    refreshChat();
});

setInterval(refreshChat, 2000);
</script>

</body>
</html>
